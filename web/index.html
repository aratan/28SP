<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroBlog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-2xl">
        <header class="bg-blue-500 text-white p-4 rounded-t-lg">
            <h1 class="text-2xl font-bold">MicroBlog</h1>
        </header>

        <div class="bg-white shadow-md rounded-b-lg p-4 mb-4">
            <input type="text" id="newTablonName" placeholder="¿Qué está pasando?"
                class="w-full p-2 border rounded mb-2">
            <button onclick="createTablon()"
                class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">Publicar</button>
        </div>

        <div id="tablones" class="space-y-4"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';

        async function fetchTablones() {
            const response = await fetch(`${API_URL}/readTablon`);
            const tablones = await response.json();
            displayTablones(tablones);
        }

        function displayTablones(tablones) {
            const tablonesDiv = document.getElementById('tablones');
            tablonesDiv.innerHTML = '';
            tablones.forEach((tablon) => {
                const tablonDiv = document.createElement('div');
                tablonDiv.className = 'bg-white p-4 rounded-lg shadow-md';
                tablonDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <img src="https://via.placeholder.com/40" alt="User" class="rounded-full mr-2">
                        <h2 class="font-bold">${tablon.name}</h2>
                    </div>
                    <div class="mb-2">
                        ${tablon.messages.map(msg => `
                            <div class="mb-3 pb-3 border-b">
                                <p class="mb-2">${msg.content.message}</p>
                                ${msg.content.videoUrl ? `
                                    <div class="mb-2">
                                        <video src="${msg.content.videoUrl}" controls class="w-full h-40 object-cover rounded"></video>
                                    </div>
                                ` : ''}
                                <div class="flex items-center text-gray-500">
                                    <button onclick="addLikeToTablon('${tablon.id}')" class="mr-3 hover:text-blue-500">
                                        <i class="far fa-heart"></i> ${tablon.likes}
                                    </button>
                                    <button onclick="deleteMessage('${tablon.id}', '${msg.id}')" class="mr-3 hover:text-red-500">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="border-t pt-3">
                        <input type="text" id="newMessage${tablon.id}" placeholder="Escribe un comentario..." class="w-full p-2 border rounded mb-2">
                        <input type="text" id="videoUrl${tablon.id}" placeholder="URL del video (opcional)" value="https://archive.org/download/deadpool-and-wolverine-red-band-trailer-x264/Deadpool%20And%20Wolverine%20%282024%29%20RedBand%20Trailer%20HD%20-%20x264.mp4" class="w-full p-2 border rounded mb-2">
                        <button onclick="addMessage('${tablon.id}')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">Comentar</button>
                    </div>
                `;
                tablonesDiv.appendChild(tablonDiv);
            });
        }

        async function createTablon() {
            const name = document.getElementById('newTablonName').value;
            await fetch(`${API_URL}/createTablon?name=${encodeURIComponent(name)}`, { method: 'POST' });
            fetchTablones();
        }

        async function addLikeToTablon(tablonId) {
            await fetch(`${API_URL}/addLikeToTablon?tablon_id=${tablonId}`, { method: 'POST' });
            fetchTablones();
        }

        async function deleteTablon(tablonId) {
            await fetch(`${API_URL}/deleteTablon?tablon_id=${tablonId}`, { method: 'DELETE' });
            fetchTablones();
        }

        async function addMessage(tablonId) {
            const message = document.getElementById(`newMessage${tablonId}`).value;
            const videoUrl = document.getElementById(`videoUrl${tablonId}`).value;
            await fetch(`${API_URL}/addMessage?tablon_id=${tablonId}&message=${encodeURIComponent(message)}&videoUrl=${encodeURIComponent(videoUrl)}`, { method: 'POST' });
            fetchTablones();
        }

        async function deleteMessage(tablonId, messageId) {
            await fetch(`${API_URL}/deleteMessageFromTablon?tablon_id=${tablonId}&message_id=${messageId}`, { method: 'DELETE' });
            fetchTablones();
        }

        fetchTablones();
    </script>
</body>

</html>